# 웹 애플리케이션 이해


## 웹 서버(Web Server)
- HTTP 기반으로 동작
- 정적 리소스 제공, 기타 부가기능
- 정적(파일) HTML, CSS, JS, 이미지, 영상
- 예) NGINX, APACHE

## 웹 애플리케이션 서버(WAS - Web Application Server)
- HTTP 기반으로 동작
- 웹 서버 기능 포함+(정적 리소스 제공 가능)
- 프로그램 코드를 실행해서 애플리케이션 로직을 수행
- 동적 HTML, HTTP API(JSON)
- 서블릿, JSP, 스프링 MVC
- 예) 톰캣(Tomcat), Jetty, Undertow

### 웹 서버와 웹 애플리케이션 서버의 차이(WAS)
- 웹 서버는 정적 리소스(파일)만, WAS는 애플리케이션 로직까지 실행할 수 있음
- 웹 서버도 프로그램을 실행하는 기능을 포함하기도 함
- 웹 애플리케이션 서버도 웹 서버의 기능을 제공
- 자바는 서블릿 컨테이너 기능을 제공하면 was
- 서블릿 없이 자바코드를 실행하는 프레임워크도 있음
- WAS는 애플리케이션 코드를 실행하는데에 특화되어있음

### 웹 시스템 구성 - WAS, DB
- WAS가 너무 많은 역할을 담당해서 서버 과부하 우려가 있음
- 가장 비싼 애플리케이션 로직이 정적 리소스 때문에 수행이 어려움
- 시스템적으로 봤을 때 정적 리소스는 그냥 파일만 잘 서빙하면 되는데, 애플리케이션 로직은 값비쌈
- WAS에 장애가 나면 정적 리소스에도 접근할 수 없음

### 웹 시스템 구성 - WEB, WAS, DB
- 일반적으로 많이 사용하는 구성
- 정적 리소스는 웹 서버가 처리
- 웹 서버는 애플리케이션 로직 같은 동적인 처리가 필요할 때 WAS에 요청을 위임함
- WAS는 중요한 애플리케이션 로직 처리 전담
- 효율적으로 리소스를 관리할 수 있음
---

## Servlet
- 비즈니스로직을 제외한 업무를 자동화해줌
  - 서버 TCP/IP 대기, 소켓 연결
  - HTTP 요청 메시지 파싱
  - HTTP 메서드 확인, URL 확인
  - Content-Type 확인
  - HTTP 바디 파싱
  - 저장 프로세스 실행
  - 응답 메시지 생성(HTTP 시작라인, 헤더, 메시지 바디 HTML...)
  - TCP/IP에 응답 전달, 소켓 종료 
- URL 이 호출되면 서블릿 코드가 실행됨
- 객체를 통해 HTTP 요청, 응답 정보를 편리하게 사용 가능함(HttpServletRequest, Response)

### HTTP 요청, 응답 흐름
- WAS는 Request, Response 객체를 만들어서 서블릿 객체 호출
- 개발자가 Request, Response 객체를 이용해 정보를 꺼내서 쓰거나 작성
- WAS는 Response 객체에 담겨있는 내용으로 HTTP 응답 정보 생성

### 서블릿 컨테이너란?
- 서블릿을 지원하는 WAS를 의미
- 서블릿 객체를 생성, 초기화, 호출, 종료하는 생명주기 관리
- 서블릿 객체는 싱글톤으로 관리
  - 공유변수 사용에 주의
  - 컨테이너 종료 시 함께 종료됨
  - 최초 로딩 시점에 만들어두고 재활용
- JSP도 서블릿으로 변환되어 사용
- 동시 요청을 위한 멀티 스레드 처리 지원 
  - 개발자가 멀티 스레드 관련 코드를 신경쓰지 않고, 마치 싱글 스레드 프로그래밍을 하듯 소스코드를 개발할 수 있음

## 스레드
- 애플리케이션 코드를 순차적으로 실행
- 자바 메인 메서드를 실행하면 main이라는 이름의 스레드가 실행됨
- 스레드가 없다면 자바 애플리케이션 실행이 불가능함
- 스레드는 한번에 하나의 코드라인만 수행함
- 동시처리가 필요할 경우 스레드를 추가로 생성해야 함

### 요청마다 스레드를 생성하는 경우
- 장점 
  - 동시 요청 처리 가능 
  - 리소스가 허용할 때까지 처리 가능 
  - 하나가 지연되어도 나머지는 정상 동작
- 단점 
  - 스레드 생성 비용이 비쌈 
  - 컨텍스트 스위칭이 일어남 
  - 스레드 생성에 제한이 없으면 cpu, 메모리 임계점을 넘어 서버가 죽을 수 있음 -> 단점을 커버하기 위해 쓰레드 풀을 사용

### 스레드풀
- 필요한 스레드를 스레드 풀에 보관하고 관리
- 생성 가능한 최대치를 관리하는 것(톰캣의 디폴트 설정은 200개)
- 스레드가 필요하면 이미 생성된 스레드를 스레드풀에서 꺼내서 사용함
- 사용 종료되면 스레드를 반납함
- 스레드풀에 남은 스레드가 없으면 대기시키거나 거절
- 장점
  - 스레드 생성, 종료 비용이 절약되고 응답시간이 빠름 
  - 생성 가능한 스레드의 최대치가 정해져있기 때문에 많은 요청이 와도 안전하게 처리 가능

### 스레드풀의 실무팁
- WAS의 주요 튜닝 포인트는 최대 스레드 수
- 이 값을 너무 낮게 설정하면?
  - 동시 요청이 많을 때 서버 리소스는 여유롭지만 클라이언트는 응답 지연에 빠짐
- 이 값을 너무 높게 설정하면?
  - 동시요청이 많으면 CPU, 메모리 리소스 임계점 초과로 서버가 다운됨
- 장애 발생 시에는
  - 클라우드 환경이라면 서버부터 늘리고 이후에 튜닝함
  - 클라우드 환경이 아닌 경우 튜닝함
- 스레드풀의 적정 숫자는 애플리케이션 로직의 복잡도, CPU, 메모리, IO 리소스 상황에 따라 다름
  - 성능테스트를 통해 판단
  - 성능 테스트 툴: 아파치 ab, 제이미터, nGrinder
---

## HTML 페이지
- 동적으로 필요한 HTML 파일을 생성해서 전달(템플릿엔진!)
- 웹브라우저가 HTML 해석해서 보여줌

## HTTP API
- HTML이 아니라 데이터를 전달함(주로 JSON)
- 다양한 시스템에서 호출함
---

## SSR - 서버 사이드 렌더링
- HTML 최종 결과를 서버에서 만들어서 웹 브라우저에 전달
- 주로 정적인 화면에서 사용 
- 관련 기술: JSP, 타임리프 -> 백엔드가 만듦

## CSR - 클라이언트 사이드 렌더링
- HTML 결과를 자바스크립트를 사용해 웹 브라우저에서 동적으로 생성해 적용
- 주로 동적인 화면에 사용하며, 웹 환경을 앱처럼 필요한 부분만 변경할 수 있음
- 예) 구글 지도, 지메일, 구글 캘린더 등
- 관련 기술: React, Vue.js -> 프론트엔드가 만듦
- 흐름
  - html 요청 시 내용이 없고 자바스크립트에 대한 정보만 있는 html 응답
  - 웹 브라우저가 자바스크립트 요청(클라이언트 로직, html 렌더링 코드)
  - HTTP API 로 데이터 요청
  - json으로 받아서 화면에 뿌림
---

## Web Reactive - Spring WebFlux
- 특징
  - 비동기 논블럭킹 처리
  - 최소 스레드로 최대 성능 -> 스레드 컨텍스트 스위칭 비용 효율화
  - 함수형 스타일로 개발 - 동시 처리 코드 효율화
  - 서블릿 기술을 사용하지 않음
- 단점
  - 기술적 난이도가 매우 높음
  - RDB 지원이 부족함
  - 일반 MVC의 스레드 모델도 충분히 빠름
  - 실무에서 많이 사용되지 않음(전체의 1% 이하)